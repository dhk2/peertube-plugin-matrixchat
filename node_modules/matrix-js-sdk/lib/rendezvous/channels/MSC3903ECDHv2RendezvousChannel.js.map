{"version":3,"file":"MSC3903ECDHv2RendezvousChannel.js","names":["_","require","_olmlib","_crypto","_SASDecimal","_NamespacedValue","ECDH_V2","UnstableValue","importKey","key","subtleCrypto","Error","imported","name","MSC3903ECDHv2RendezvousChannel","constructor","transport","theirPublicKey","onFailure","_defineProperty2","default","olmSAS","global","Olm","SAS","ourPublicKey","decodeBase64","get_pubkey","generateCode","intent","ready","send","algorithm","rendezvous","encodeUnpaddedBase64","details","connect","connected","isInitiator","rawRes","receive","res","matches","RendezvousError","RendezvousFailureReason","UnsupportedAlgorithm","set_their_key","initiatorKey","recipientKey","aesInfo","aesKeyBytes","generate_bytes","aesKey","fill","rawChecksum","generateDecimalSas","Array","from","join","encrypt","data","iv","Uint8Array","crypto","getRandomValues","encodedData","TextEncoder","encode","JSON","stringify","ciphertext","tagLength","payload","decrypt","ciphertextBytes","plaintext","parse","TextDecoder","decode","rawData","undefined","close","free","cancel","reason","exports"],"sources":["../../../src/rendezvous/channels/MSC3903ECDHv2RendezvousChannel.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { SAS } from \"@matrix-org/olm\";\n\nimport {\n    RendezvousError,\n    RendezvousCode,\n    RendezvousIntent,\n    RendezvousChannel,\n    RendezvousTransportDetails,\n    RendezvousTransport,\n    RendezvousFailureReason,\n} from \"..\";\nimport { encodeUnpaddedBase64, decodeBase64 } from \"../../crypto/olmlib\";\nimport { crypto, subtleCrypto, TextEncoder } from \"../../crypto/crypto\";\nimport { generateDecimalSas } from \"../../crypto/verification/SASDecimal\";\nimport { UnstableValue } from \"../../NamespacedValue\";\n\nconst ECDH_V2 = new UnstableValue(\n    \"m.rendezvous.v2.curve25519-aes-sha256\",\n    \"org.matrix.msc3903.rendezvous.v2.curve25519-aes-sha256\",\n);\n\nexport interface ECDHv2RendezvousCode extends RendezvousCode {\n    rendezvous: {\n        transport: RendezvousTransportDetails;\n        algorithm: typeof ECDH_V2.name | typeof ECDH_V2.altName;\n        key: string;\n    };\n}\n\nexport type MSC3903ECDHPayload = PlainTextPayload | EncryptedPayload;\n\nexport interface PlainTextPayload {\n    algorithm: typeof ECDH_V2.name | typeof ECDH_V2.altName;\n    key?: string;\n}\n\nexport interface EncryptedPayload {\n    iv: string;\n    ciphertext: string;\n}\n\nasync function importKey(key: Uint8Array): Promise<CryptoKey> {\n    if (!subtleCrypto) {\n        throw new Error(\"Web Crypto is not available\");\n    }\n\n    const imported = subtleCrypto.importKey(\"raw\", key, { name: \"AES-GCM\" }, false, [\"encrypt\", \"decrypt\"]);\n\n    return imported;\n}\n\n/**\n * Implementation of the unstable [MSC3903](https://github.com/matrix-org/matrix-spec-proposals/pull/3903)\n * X25519/ECDH key agreement based secure rendezvous channel.\n * Note that this is UNSTABLE and may have breaking changes without notice.\n */\nexport class MSC3903ECDHv2RendezvousChannel<T> implements RendezvousChannel<T> {\n    private olmSAS?: SAS;\n    private ourPublicKey: Uint8Array;\n    private aesKey?: CryptoKey;\n    private connected = false;\n\n    public constructor(\n        private transport: RendezvousTransport<MSC3903ECDHPayload>,\n        private theirPublicKey?: Uint8Array,\n        public onFailure?: (reason: RendezvousFailureReason) => void,\n    ) {\n        this.olmSAS = new global.Olm.SAS();\n        this.ourPublicKey = decodeBase64(this.olmSAS.get_pubkey());\n    }\n\n    public async generateCode(intent: RendezvousIntent): Promise<ECDHv2RendezvousCode> {\n        if (this.transport.ready) {\n            throw new Error(\"Code already generated\");\n        }\n\n        await this.transport.send({ algorithm: ECDH_V2.name });\n\n        const rendezvous: ECDHv2RendezvousCode = {\n            rendezvous: {\n                algorithm: ECDH_V2.name,\n                key: encodeUnpaddedBase64(this.ourPublicKey),\n                transport: await this.transport.details(),\n            },\n            intent,\n        };\n\n        return rendezvous;\n    }\n\n    public async connect(): Promise<string> {\n        if (this.connected) {\n            throw new Error(\"Channel already connected\");\n        }\n\n        if (!this.olmSAS) {\n            throw new Error(\"Channel closed\");\n        }\n\n        const isInitiator = !this.theirPublicKey;\n\n        if (isInitiator) {\n            // wait for the other side to send us their public key\n            const rawRes = await this.transport.receive();\n            if (!rawRes) {\n                throw new Error(\"No response from other device\");\n            }\n            const res = rawRes as Partial<PlainTextPayload>;\n            const { key, algorithm } = res;\n            if (!algorithm || !ECDH_V2.matches(algorithm) || !key) {\n                throw new RendezvousError(\n                    \"Unsupported algorithm: \" + algorithm,\n                    RendezvousFailureReason.UnsupportedAlgorithm,\n                );\n            }\n\n            this.theirPublicKey = decodeBase64(key);\n        } else {\n            // send our public key unencrypted\n            await this.transport.send({\n                algorithm: ECDH_V2.name,\n                key: encodeUnpaddedBase64(this.ourPublicKey),\n            });\n        }\n\n        this.connected = true;\n\n        this.olmSAS.set_their_key(encodeUnpaddedBase64(this.theirPublicKey!));\n\n        const initiatorKey = isInitiator ? this.ourPublicKey : this.theirPublicKey!;\n        const recipientKey = isInitiator ? this.theirPublicKey! : this.ourPublicKey;\n        let aesInfo = ECDH_V2.name;\n        aesInfo += `|${encodeUnpaddedBase64(initiatorKey)}`;\n        aesInfo += `|${encodeUnpaddedBase64(recipientKey)}`;\n\n        const aesKeyBytes = this.olmSAS.generate_bytes(aesInfo, 32);\n\n        this.aesKey = await importKey(aesKeyBytes);\n\n        // blank the bytes out to make sure not kept in memory\n        aesKeyBytes.fill(0);\n\n        const rawChecksum = this.olmSAS.generate_bytes(aesInfo, 5);\n        return generateDecimalSas(Array.from(rawChecksum)).join(\"-\");\n    }\n\n    private async encrypt(data: T): Promise<MSC3903ECDHPayload> {\n        if (!subtleCrypto) {\n            throw new Error(\"Web Crypto is not available\");\n        }\n\n        const iv = new Uint8Array(32);\n        crypto.getRandomValues(iv);\n\n        const encodedData = new TextEncoder().encode(JSON.stringify(data));\n\n        const ciphertext = await subtleCrypto.encrypt(\n            {\n                name: \"AES-GCM\",\n                iv,\n                tagLength: 128,\n            },\n            this.aesKey as CryptoKey,\n            encodedData,\n        );\n\n        return {\n            iv: encodeUnpaddedBase64(iv),\n            ciphertext: encodeUnpaddedBase64(ciphertext),\n        };\n    }\n\n    public async send(payload: T): Promise<void> {\n        if (!this.olmSAS) {\n            throw new Error(\"Channel closed\");\n        }\n\n        if (!this.aesKey) {\n            throw new Error(\"Shared secret not set up\");\n        }\n\n        return this.transport.send(await this.encrypt(payload));\n    }\n\n    private async decrypt({ iv, ciphertext }: EncryptedPayload): Promise<Partial<T>> {\n        if (!ciphertext || !iv) {\n            throw new Error(\"Missing ciphertext and/or iv\");\n        }\n\n        const ciphertextBytes = decodeBase64(ciphertext);\n\n        if (!subtleCrypto) {\n            throw new Error(\"Web Crypto is not available\");\n        }\n\n        const plaintext = await subtleCrypto.decrypt(\n            {\n                name: \"AES-GCM\",\n                iv: decodeBase64(iv),\n                tagLength: 128,\n            },\n            this.aesKey as CryptoKey,\n            ciphertextBytes,\n        );\n\n        return JSON.parse(new TextDecoder().decode(new Uint8Array(plaintext)));\n    }\n\n    public async receive(): Promise<Partial<T> | undefined> {\n        if (!this.olmSAS) {\n            throw new Error(\"Channel closed\");\n        }\n        if (!this.aesKey) {\n            throw new Error(\"Shared secret not set up\");\n        }\n\n        const rawData = await this.transport.receive();\n        if (!rawData) {\n            return undefined;\n        }\n        const data = rawData as Partial<EncryptedPayload>;\n        if (data.ciphertext && data.iv) {\n            return this.decrypt(data as EncryptedPayload);\n        }\n\n        throw new Error(\"Data received but no ciphertext\");\n    }\n\n    public async close(): Promise<void> {\n        if (this.olmSAS) {\n            this.olmSAS.free();\n            this.olmSAS = undefined;\n        }\n    }\n\n    public async cancel(reason: RendezvousFailureReason): Promise<void> {\n        try {\n            await this.transport.cancel(reason);\n        } finally {\n            await this.close();\n        }\n    }\n}\n"],"mappings":"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"}