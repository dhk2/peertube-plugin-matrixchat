{"version":3,"file":"room-hierarchy.js","names":["_event","require","RoomHierarchy","constructor","root","pageSize","maxDepth","suggestedOnly","_defineProperty2","default","Map","noSupport","serverSupportError","canLoadMore","nextBatch","_rooms","loading","loadRequest","rooms","load","then","r","client","getRoomHierarchy","roomId","next_batch","e","errcode","undefined","concat","forEach","room","roomMap","set","room_id","children_state","ev","type","EventType","SpaceChild","childRoomId","state_key","backRefs","has","get","push","Array","isArray","content","via","viaMap","Set","vias","add","getRelation","parentId","childId","_this$roomMap$get","find","isSuggested","_this$getRelation","suggested","removeRelation","length","delete","filter","ref","exports"],"sources":["../src/room-hierarchy.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { Room } from \"./models/room\";\nimport { IHierarchyRoom, IHierarchyRelation } from \"./@types/spaces\";\nimport { MatrixClient } from \"./client\";\nimport { EventType } from \"./@types/event\";\nimport { MatrixError } from \"./http-api\";\n\nexport class RoomHierarchy {\n    // Map from room id to list of servers which are listed as a via somewhere in the loaded hierarchy\n    public readonly viaMap = new Map<string, Set<string>>();\n    // Map from room id to list of rooms which claim this room as their child\n    public readonly backRefs = new Map<string, string[]>();\n    // Map from room id to object\n    public readonly roomMap = new Map<string, IHierarchyRoom>();\n    private loadRequest?: ReturnType<MatrixClient[\"getRoomHierarchy\"]>;\n    private nextBatch?: string;\n    private _rooms?: IHierarchyRoom[];\n    private serverSupportError?: Error;\n\n    /**\n     * Construct a new RoomHierarchy\n     *\n     * A RoomHierarchy instance allows you to easily make use of the /hierarchy API and paginate it.\n     *\n     * @param root - the root of this hierarchy\n     * @param pageSize - the maximum number of rooms to return per page, can be overridden per load request.\n     * @param maxDepth - the maximum depth to traverse the hierarchy to\n     * @param suggestedOnly - whether to only return rooms with suggested=true.\n     */\n    public constructor(\n        public readonly root: Room,\n        private readonly pageSize?: number,\n        private readonly maxDepth?: number,\n        private readonly suggestedOnly = false,\n    ) {}\n\n    public get noSupport(): boolean {\n        return !!this.serverSupportError;\n    }\n\n    public get canLoadMore(): boolean {\n        return !!this.serverSupportError || !!this.nextBatch || !this._rooms;\n    }\n\n    public get loading(): boolean {\n        return !!this.loadRequest;\n    }\n\n    public get rooms(): IHierarchyRoom[] | undefined {\n        return this._rooms;\n    }\n\n    public async load(pageSize = this.pageSize): Promise<IHierarchyRoom[]> {\n        if (this.loadRequest) return this.loadRequest.then((r) => r.rooms);\n\n        this.loadRequest = this.root.client.getRoomHierarchy(\n            this.root.roomId,\n            pageSize,\n            this.maxDepth,\n            this.suggestedOnly,\n            this.nextBatch,\n        );\n\n        let rooms: IHierarchyRoom[];\n        try {\n            ({ rooms, next_batch: this.nextBatch } = await this.loadRequest);\n        } catch (e) {\n            if ((<MatrixError>e).errcode === \"M_UNRECOGNIZED\") {\n                this.serverSupportError = <MatrixError>e;\n            } else {\n                throw e;\n            }\n\n            return [];\n        } finally {\n            this.loadRequest = undefined;\n        }\n\n        if (this._rooms) {\n            this._rooms = this._rooms.concat(rooms);\n        } else {\n            this._rooms = rooms;\n        }\n\n        rooms.forEach((room) => {\n            this.roomMap.set(room.room_id, room);\n\n            room.children_state.forEach((ev) => {\n                if (ev.type !== EventType.SpaceChild) return;\n                const childRoomId = ev.state_key;\n\n                // track backrefs for quicker hierarchy navigation\n                if (!this.backRefs.has(childRoomId)) {\n                    this.backRefs.set(childRoomId, []);\n                }\n                this.backRefs.get(childRoomId)!.push(room.room_id);\n\n                // fill viaMap\n                if (Array.isArray(ev.content.via)) {\n                    if (!this.viaMap.has(childRoomId)) {\n                        this.viaMap.set(childRoomId, new Set());\n                    }\n                    const vias = this.viaMap.get(childRoomId)!;\n                    ev.content.via.forEach((via) => vias.add(via));\n                }\n            });\n        });\n\n        return rooms;\n    }\n\n    public getRelation(parentId: string, childId: string): IHierarchyRelation | undefined {\n        return this.roomMap.get(parentId)?.children_state.find((e) => e.state_key === childId);\n    }\n\n    public isSuggested(parentId: string, childId: string): boolean | undefined {\n        return this.getRelation(parentId, childId)?.content.suggested;\n    }\n\n    // locally remove a relation as a form of local echo\n    public removeRelation(parentId: string, childId: string): void {\n        const backRefs = this.backRefs.get(childId);\n        if (backRefs?.length === 1) {\n            this.backRefs.delete(childId);\n        } else if (backRefs?.length) {\n            this.backRefs.set(\n                childId,\n                backRefs.filter((ref) => ref !== parentId),\n            );\n        }\n\n        const room = this.roomMap.get(parentId);\n        if (room) {\n            room.children_state = room.children_state.filter((ev) => ev.state_key !== childId);\n        }\n    }\n}\n"],"mappings":";;;;;;;;AAmBA,IAAAA,MAAA,GAAAC,OAAA;AAnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAQO,MAAMC,aAAa,CAAC;EACvB;;EAEA;;EAEA;;EAOA;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACWC,WAAWA,CACEC,IAAU,EACTC,QAAiB,EACjBC,QAAiB,EACjBC,aAAa,GAAG,KAAK,EACxC;IAAA,KAJkBH,IAAU,GAAVA,IAAU;IAAA,KACTC,QAAiB,GAAjBA,QAAiB;IAAA,KACjBC,QAAiB,GAAjBA,QAAiB;IAAA,KACjBC,aAAa,GAAbA,aAAa;IAAA,IAAAC,gBAAA,CAAAC,OAAA,kBAxBT,IAAIC,GAAG,EAAuB;IAAA,IAAAF,gBAAA,CAAAC,OAAA,oBAE5B,IAAIC,GAAG,EAAoB;IAAA,IAAAF,gBAAA,CAAAC,OAAA,mBAE5B,IAAIC,GAAG,EAA0B;IAAA,IAAAF,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;EAqBxD;EAEH,IAAWE,SAASA,CAAA,EAAY;IAC5B,OAAO,CAAC,CAAC,IAAI,CAACC,kBAAkB;EACpC;EAEA,IAAWC,WAAWA,CAAA,EAAY;IAC9B,OAAO,CAAC,CAAC,IAAI,CAACD,kBAAkB,IAAI,CAAC,CAAC,IAAI,CAACE,SAAS,IAAI,CAAC,IAAI,CAACC,MAAM;EACxE;EAEA,IAAWC,OAAOA,CAAA,EAAY;IAC1B,OAAO,CAAC,CAAC,IAAI,CAACC,WAAW;EAC7B;EAEA,IAAWC,KAAKA,CAAA,EAAiC;IAC7C,OAAO,IAAI,CAACH,MAAM;EACtB;EAEA,MAAaI,IAAIA,CAACd,QAAQ,GAAG,IAAI,CAACA,QAAQ,EAA6B;IACnE,IAAI,IAAI,CAACY,WAAW,EAAE,OAAO,IAAI,CAACA,WAAW,CAACG,IAAI,CAAEC,CAAC,IAAKA,CAAC,CAACH,KAAK,CAAC;IAElE,IAAI,CAACD,WAAW,GAAG,IAAI,CAACb,IAAI,CAACkB,MAAM,CAACC,gBAAgB,CAChD,IAAI,CAACnB,IAAI,CAACoB,MAAM,EAChBnB,QAAQ,EACR,IAAI,CAACC,QAAQ,EACb,IAAI,CAACC,aAAa,EAClB,IAAI,CAACO,SAAS,CACjB;IAED,IAAII,KAAuB;IAC3B,IAAI;MACA,CAAC;QAAEA,KAAK;QAAEO,UAAU,EAAE,IAAI,CAACX;MAAU,CAAC,GAAG,MAAM,IAAI,CAACG,WAAW;IACnE,CAAC,CAAC,OAAOS,CAAC,EAAE;MACR,IAAkBA,CAAC,CAAEC,OAAO,KAAK,gBAAgB,EAAE;QAC/C,IAAI,CAACf,kBAAkB,GAAgBc,CAAC;MAC5C,CAAC,MAAM;QACH,MAAMA,CAAC;MACX;MAEA,OAAO,EAAE;IACb,CAAC,SAAS;MACN,IAAI,CAACT,WAAW,GAAGW,SAAS;IAChC;IAEA,IAAI,IAAI,CAACb,MAAM,EAAE;MACb,IAAI,CAACA,MAAM,GAAG,IAAI,CAACA,MAAM,CAACc,MAAM,CAACX,KAAK,CAAC;IAC3C,CAAC,MAAM;MACH,IAAI,CAACH,MAAM,GAAGG,KAAK;IACvB;IAEAA,KAAK,CAACY,OAAO,CAAEC,IAAI,IAAK;MACpB,IAAI,CAACC,OAAO,CAACC,GAAG,CAACF,IAAI,CAACG,OAAO,EAAEH,IAAI,CAAC;MAEpCA,IAAI,CAACI,cAAc,CAACL,OAAO,CAAEM,EAAE,IAAK;QAChC,IAAIA,EAAE,CAACC,IAAI,KAAKC,gBAAS,CAACC,UAAU,EAAE;QACtC,MAAMC,WAAW,GAAGJ,EAAE,CAACK,SAAS;;QAEhC;QACA,IAAI,CAAC,IAAI,CAACC,QAAQ,CAACC,GAAG,CAACH,WAAW,CAAC,EAAE;UACjC,IAAI,CAACE,QAAQ,CAACT,GAAG,CAACO,WAAW,EAAE,EAAE,CAAC;QACtC;QACA,IAAI,CAACE,QAAQ,CAACE,GAAG,CAACJ,WAAW,CAAC,CAAEK,IAAI,CAACd,IAAI,CAACG,OAAO,CAAC;;QAElD;QACA,IAAIY,KAAK,CAACC,OAAO,CAACX,EAAE,CAACY,OAAO,CAACC,GAAG,CAAC,EAAE;UAC/B,IAAI,CAAC,IAAI,CAACC,MAAM,CAACP,GAAG,CAACH,WAAW,CAAC,EAAE;YAC/B,IAAI,CAACU,MAAM,CAACjB,GAAG,CAACO,WAAW,EAAE,IAAIW,GAAG,EAAE,CAAC;UAC3C;UACA,MAAMC,IAAI,GAAG,IAAI,CAACF,MAAM,CAACN,GAAG,CAACJ,WAAW,CAAE;UAC1CJ,EAAE,CAACY,OAAO,CAACC,GAAG,CAACnB,OAAO,CAAEmB,GAAG,IAAKG,IAAI,CAACC,GAAG,CAACJ,GAAG,CAAC,CAAC;QAClD;MACJ,CAAC,CAAC;IACN,CAAC,CAAC;IAEF,OAAO/B,KAAK;EAChB;EAEOoC,WAAWA,CAACC,QAAgB,EAAEC,OAAe,EAAkC;IAAA,IAAAC,iBAAA;IAClF,QAAAA,iBAAA,GAAO,IAAI,CAACzB,OAAO,CAACY,GAAG,CAACW,QAAQ,CAAC,cAAAE,iBAAA,uBAA1BA,iBAAA,CAA4BtB,cAAc,CAACuB,IAAI,CAAEhC,CAAC,IAAKA,CAAC,CAACe,SAAS,KAAKe,OAAO,CAAC;EAC1F;EAEOG,WAAWA,CAACJ,QAAgB,EAAEC,OAAe,EAAuB;IAAA,IAAAI,iBAAA;IACvE,QAAAA,iBAAA,GAAO,IAAI,CAACN,WAAW,CAACC,QAAQ,EAAEC,OAAO,CAAC,cAAAI,iBAAA,uBAAnCA,iBAAA,CAAqCZ,OAAO,CAACa,SAAS;EACjE;;EAEA;EACOC,cAAcA,CAACP,QAAgB,EAAEC,OAAe,EAAQ;IAC3D,MAAMd,QAAQ,GAAG,IAAI,CAACA,QAAQ,CAACE,GAAG,CAACY,OAAO,CAAC;IAC3C,IAAI,CAAAd,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAEqB,MAAM,MAAK,CAAC,EAAE;MACxB,IAAI,CAACrB,QAAQ,CAACsB,MAAM,CAACR,OAAO,CAAC;IACjC,CAAC,MAAM,IAAId,QAAQ,aAARA,QAAQ,eAARA,QAAQ,CAAEqB,MAAM,EAAE;MACzB,IAAI,CAACrB,QAAQ,CAACT,GAAG,CACbuB,OAAO,EACPd,QAAQ,CAACuB,MAAM,CAAEC,GAAG,IAAKA,GAAG,KAAKX,QAAQ,CAAC,CAC7C;IACL;IAEA,MAAMxB,IAAI,GAAG,IAAI,CAACC,OAAO,CAACY,GAAG,CAACW,QAAQ,CAAC;IACvC,IAAIxB,IAAI,EAAE;MACNA,IAAI,CAACI,cAAc,GAAGJ,IAAI,CAACI,cAAc,CAAC8B,MAAM,CAAE7B,EAAE,IAAKA,EAAE,CAACK,SAAS,KAAKe,OAAO,CAAC;IACtF;EACJ;AACJ;AAACW,OAAA,CAAAjE,aAAA,GAAAA,aAAA"}