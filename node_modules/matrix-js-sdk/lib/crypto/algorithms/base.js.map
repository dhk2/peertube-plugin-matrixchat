{"version":3,"file":"base.js","names":["ENCRYPTION_CLASSES","Map","exports","DECRYPTION_CLASSES","EncryptionAlgorithm","constructor","params","_defineProperty2","default","userId","deviceId","crypto","olmDevice","baseApis","roomId","prepareToEncrypt","room","onRoomMembership","event","member","oldMembership","DecryptionAlgorithm","onRoomKeyEvent","importRoomKey","session","opts","hasKeysForKeyRequest","keyRequest","Promise","resolve","shareKeysWithDevice","Error","retryDecryptionFromSender","senderKey","DecryptionError","code","msg","details","name","detailedString","detailedStringForDecryptionError","err","result","message","Object","keys","map","k","join","UnknownDeviceError","devices","registerAlgorithm","algorithm","encryptor","decryptor","set"],"sources":["../../../src/crypto/algorithms/base.ts"],"sourcesContent":["/*\nCopyright 2016 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n/**\n * Internal module. Defines the base classes of the encryption implementations\n */\n\nimport type { IMegolmSessionData } from \"../../@types/crypto\";\nimport { MatrixClient } from \"../../client\";\nimport { Room } from \"../../models/room\";\nimport { OlmDevice } from \"../OlmDevice\";\nimport { IContent, MatrixEvent, RoomMember } from \"../../matrix\";\nimport { Crypto, IEncryptedContent, IEventDecryptionResult, IncomingRoomKeyRequest } from \"..\";\nimport { DeviceInfo } from \"../deviceinfo\";\nimport { IRoomEncryption } from \"../RoomList\";\n\n/**\n * Map of registered encryption algorithm classes. A map from string to {@link EncryptionAlgorithm} class\n */\nexport const ENCRYPTION_CLASSES = new Map<string, new (params: IParams) => EncryptionAlgorithm>();\n\nexport type DecryptionClassParams<P extends IParams = IParams> = Omit<P, \"deviceId\" | \"config\">;\n\n/**\n * map of registered encryption algorithm classes. Map from string to {@link DecryptionAlgorithm} class\n */\nexport const DECRYPTION_CLASSES = new Map<string, new (params: DecryptionClassParams) => DecryptionAlgorithm>();\n\nexport interface IParams {\n    /** The UserID for the local user */\n    userId: string;\n    /** The identifier for this device. */\n    deviceId: string;\n    /** crypto core */\n    crypto: Crypto;\n    /** olm.js wrapper */\n    olmDevice: OlmDevice;\n    /** base matrix api interface */\n    baseApis: MatrixClient;\n    /** The ID of the room we will be sending to */\n    roomId?: string;\n    /** The body of the m.room.encryption event */\n    config: IRoomEncryption & object;\n}\n\n/**\n * base type for encryption implementations\n */\nexport abstract class EncryptionAlgorithm {\n    protected readonly userId: string;\n    protected readonly deviceId: string;\n    protected readonly crypto: Crypto;\n    protected readonly olmDevice: OlmDevice;\n    protected readonly baseApis: MatrixClient;\n    protected readonly roomId?: string;\n\n    /**\n     * @param params - parameters\n     */\n    public constructor(params: IParams) {\n        this.userId = params.userId;\n        this.deviceId = params.deviceId;\n        this.crypto = params.crypto;\n        this.olmDevice = params.olmDevice;\n        this.baseApis = params.baseApis;\n        this.roomId = params.roomId;\n    }\n\n    /**\n     * Perform any background tasks that can be done before a message is ready to\n     * send, in order to speed up sending of the message.\n     *\n     * @param room - the room the event is in\n     */\n    public prepareToEncrypt(room: Room): void {}\n\n    /**\n     * Encrypt a message event\n     *\n     * @public\n     *\n     * @param content - event content\n     *\n     * @returns Promise which resolves to the new event body\n     */\n    public abstract encryptMessage(room: Room, eventType: string, content: IContent): Promise<IEncryptedContent>;\n\n    /**\n     * Called when the membership of a member of the room changes.\n     *\n     * @param event -  event causing the change\n     * @param member -  user whose membership changed\n     * @param oldMembership -  previous membership\n     * @public\n     */\n    public onRoomMembership(event: MatrixEvent, member: RoomMember, oldMembership?: string): void {}\n\n    public reshareKeyWithDevice?(\n        senderKey: string,\n        sessionId: string,\n        userId: string,\n        device: DeviceInfo,\n    ): Promise<void>;\n\n    public forceDiscardSession?(): void;\n}\n\n/**\n * base type for decryption implementations\n */\nexport abstract class DecryptionAlgorithm {\n    protected readonly userId: string;\n    protected readonly crypto: Crypto;\n    protected readonly olmDevice: OlmDevice;\n    protected readonly baseApis: MatrixClient;\n    protected readonly roomId?: string;\n\n    public constructor(params: DecryptionClassParams) {\n        this.userId = params.userId;\n        this.crypto = params.crypto;\n        this.olmDevice = params.olmDevice;\n        this.baseApis = params.baseApis;\n        this.roomId = params.roomId;\n    }\n\n    /**\n     * Decrypt an event\n     *\n     * @param event - undecrypted event\n     *\n     * @returns promise which\n     * resolves once we have finished decrypting. Rejects with an\n     * `algorithms.DecryptionError` if there is a problem decrypting the event.\n     */\n    public abstract decryptEvent(event: MatrixEvent): Promise<IEventDecryptionResult>;\n\n    /**\n     * Handle a key event\n     *\n     * @param params - event key event\n     */\n    public async onRoomKeyEvent(params: MatrixEvent): Promise<void> {\n        // ignore by default\n    }\n\n    /**\n     * Import a room key\n     *\n     * @param opts - object\n     */\n    public async importRoomKey(session: IMegolmSessionData, opts: object): Promise<void> {\n        // ignore by default\n    }\n\n    /**\n     * Determine if we have the keys necessary to respond to a room key request\n     *\n     * @returns true if we have the keys and could (theoretically) share\n     *  them; else false.\n     */\n    public hasKeysForKeyRequest(keyRequest: IncomingRoomKeyRequest): Promise<boolean> {\n        return Promise.resolve(false);\n    }\n\n    /**\n     * Send the response to a room key request\n     *\n     */\n    public shareKeysWithDevice(keyRequest: IncomingRoomKeyRequest): void {\n        throw new Error(\"shareKeysWithDevice not supported for this DecryptionAlgorithm\");\n    }\n\n    /**\n     * Retry decrypting all the events from a sender that haven't been\n     * decrypted yet.\n     *\n     * @param senderKey - the sender's key\n     */\n    public async retryDecryptionFromSender(senderKey: string): Promise<boolean> {\n        // ignore by default\n        return false;\n    }\n\n    public onRoomKeyWithheldEvent?(event: MatrixEvent): Promise<void>;\n    public sendSharedHistoryInboundSessions?(devicesByUser: Record<string, DeviceInfo[]>): Promise<void>;\n}\n\n/**\n * Exception thrown when decryption fails\n *\n * @param msg - user-visible message describing the problem\n *\n * @param details - key/value pairs reported in the logs but not shown\n *   to the user.\n */\nexport class DecryptionError extends Error {\n    public readonly detailedString: string;\n\n    public constructor(public readonly code: string, msg: string, details?: Record<string, string | Error>) {\n        super(msg);\n        this.code = code;\n        this.name = \"DecryptionError\";\n        this.detailedString = detailedStringForDecryptionError(this, details);\n    }\n}\n\nfunction detailedStringForDecryptionError(err: DecryptionError, details?: Record<string, string | Error>): string {\n    let result = err.name + \"[msg: \" + err.message;\n\n    if (details) {\n        result +=\n            \", \" +\n            Object.keys(details)\n                .map((k) => k + \": \" + details[k])\n                .join(\", \");\n    }\n\n    result += \"]\";\n\n    return result;\n}\n\nexport class UnknownDeviceError extends Error {\n    /**\n     * Exception thrown specifically when we want to warn the user to consider\n     * the security of their conversation before continuing\n     *\n     * @param msg - message describing the problem\n     * @param devices - set of unknown devices per user we're warning about\n     */\n    public constructor(\n        msg: string,\n        public readonly devices: Record<string, Record<string, object>>,\n        public event?: MatrixEvent,\n    ) {\n        super(msg);\n        this.name = \"UnknownDeviceError\";\n        this.devices = devices;\n    }\n}\n\n/**\n * Registers an encryption/decryption class for a particular algorithm\n *\n * @param algorithm - algorithm tag to register for\n *\n * @param encryptor - {@link EncryptionAlgorithm} implementation\n *\n * @param decryptor - {@link DecryptionAlgorithm} implementation\n */\nexport function registerAlgorithm<P extends IParams = IParams>(\n    algorithm: string,\n    encryptor: new (params: P) => EncryptionAlgorithm,\n    decryptor: new (params: DecryptionClassParams<P>) => DecryptionAlgorithm,\n): void {\n    ENCRYPTION_CLASSES.set(algorithm, encryptor as new (params: IParams) => EncryptionAlgorithm);\n    DECRYPTION_CLASSES.set(algorithm, decryptor as new (params: DecryptionClassParams) => DecryptionAlgorithm);\n}\n"],"mappings":"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"}